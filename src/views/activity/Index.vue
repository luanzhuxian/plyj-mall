<template>
  <div :class="$style.activity">
    <template-xinchun
      v-if="type === 8"
      :data="modules"
      :type="type"
    />
    <div :class="$style.d12" v-if="~[5, 6, 7].indexOf(type)">
      <div :class="$style.background">
        <search placeholder="搜索商品" />
        <div :class="$style.container" v-if="allLoaded">
          <router-link
            :class="{
              [$style.btnTop]: true,
              [$style.coupon]: topBtnType === 1,
              [$style.default]: topBtnType === 2,
            }"
            tag="div"
            :to="{ name: topBtnType === 1 ? 'MyCoupon' : '' }"
          />
          <template-fengqiang
            v-if="type === 5"
            :data="modules"
            :type="type"
          />
          <template-baofa
            v-if="type === 6"
            :data="modules"
            :type="type"
          />
          <template-fanchang
            v-if="type === 7"
            :data="modules"
            :type="type"
          />
        </div>
      </div>
      <invite-newcomers-home-entry />
      <newcomers-home-entry />
    </div>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'
import Search from './components/Search.vue'
import TemplateFengqiang from './Template-Fengqiang.vue'
import TemplateBaofa from './Template-Baofa.vue'
import TemplateFanchang from './Template-Fanchang.vue'
import TemplateXinchun from './Template-Xinchun.vue'
import InviteNewcomersHomeEntry from '../double-twelve-day/invitenewcomers/InviteNewcomersHomeEntry.vue'
import NewcomersHomeEntry from '../double-twelve-day/newcomers/NewcomersHomeEntry.vue'
// import { getTemplate, getLiveInfo, getJianxueInfo } from '../../apis/home'
// import { getMyCouponList } from '../../apis/my-coupon'
// import { getCurrentActivity } from '../../apis/invitenewcomers'

export default {
  name: 'Activity',
  components: {
    Search,
    TemplateFengqiang,
    TemplateBaofa,
    TemplateFanchang,
    TemplateXinchun,
    InviteNewcomersHomeEntry,
    NewcomersHomeEntry
  },
  provide () {
    return {
      parent: this
    }
  },
  data () {
    return {
      type: 0,
      modules: {
        COUPON: null,
        MAI_SONG: null,
        PIN_TUAN: null,
        YU_GOU: null,
        MIAO_SHA: null,
        FENG_QIANG: null,
        RECOMMEND: null
      }
      // liveInfo: {}, // 直播
      // invitingEvent: {}, // 邀新有礼
      // jxEvent: {}, // 见学之路
      // topBtnType: 0 // 0：不显示 1：优惠卷 2：默认
    }
  },
  computed: {
    ...mapGetters(['activityData', 'activityId', 'liveInfo', 'd12CouponTotal', 'xinchunCouponTotal', 'invitingEvent', 'jxEvent', 'nwEvent']),
    topBtnType () {
      if (this.d12CouponTotal === null) return false
      return this.d12CouponTotal ? 1 : 2
    },
    allLoaded () {
      let result
      if ([5, 6, 7].includes(this.activityId)) {
        result = (this.liveInfo !== null && !!this.liveInfo) &&
        (this.d12CouponTotal !== null && !!this.d12CouponTotal) &&
        (this.invitingEvent !== null && !!this.invitingEvent) &&
        (this.jxEvent !== null && !!this.jxEvent)
      }
      if (this.activityId === 8) {
        result = (this.liveInfo !== null && !!this.liveInfo) &&
        (this.XinchunCouponTLotal !== null && !!this.XinchunCouponTotal) &&
        (this.nwEvent !== null && !!this.nwEvent)
      }
      return result
    }
  },
  watch: {
    activityId: {
      handler (id) {
        if (!id && id !== 0) return
        this.getTemplate()
      },
      immediate: true
    }
  },
  async created () {
    try {
      // const type = await this.getTemplate()
      // // 查询直播
      // getLiveInfo().then(({ result }) => {
      //   this.liveInfo = result || {}
      // })
      // // 查询可使用优惠卷
      // getMyCouponList({ current: 1, size: 10, status: 0 })
      //   .then(({ result }) => {
      //     this.topBtnType = result.total ? 1 : 2
      //   })
      //   .catch(err => {
      //     this.topBtnType = 2
      //     throw err
      //   })
      // if (type && ~[5, 6, 7].indexOf(type)) {
      //   // 邀新有礼
      //   getCurrentActivity().then(({ result }) => {
      //     this.invitingEvent = result || {}
      //   })
      //   // 见学之路
      //   getJianxueInfo().then(({ result }) => {
      //     this.jxEvent = result || {}
      //   })
      // }
    } catch (e) {
      throw e
    }
  },
  methods: {
    async getTemplate () {
      try {
        const { activityId } = this
        // const { result } = await getTemplate({ type: 2 })
        if (activityId === 0) {
          this.noFinish = true
          this.$alert('主会场还在装修中哦，请您先看看我们都有哪些商品吧 😘')
            .finally(() => {
              this.$router.replace({ name: 'Classify' })
            })
          return false
        }
        let { type, moduleModels } = this.activityData
        if (type === 5) {
          this.modules.MIAO_SHA = moduleModels[0]
          this.modules.PIN_TUAN = moduleModels[1]
          this.modules.MAI_SONG = moduleModels[2]
          this.modules.COUPON = moduleModels[3]
          this.modules.YU_GOU = moduleModels[4]
          this.modules.FENG_QIANG = moduleModels[5]
          this.modules.RECOMMEND = moduleModels[6]
        }
        if (type === 6) {
          this.modules.COUPON = moduleModels[0]
          this.modules.MAI_SONG = moduleModels[1]
          this.modules.MIAO_SHA = moduleModels[2]
          this.modules.PIN_TUAN = moduleModels[3]
          this.modules.FENG_QIANG = moduleModels[4]
          this.modules.MIAO_SHA.values.forEach((item, index) => {
            if (!item.goodsInfo || !Array.isArray(item.goodsInfo)) {
              item.goodsInfo = []
            }
            this.$set(item, 'range', item.valueName.split(','))
          })
        }
        if (type === 7) {
          this.modules.MAI_SONG = moduleModels[0]
          this.modules.MIAO_SHA = moduleModels[1]
          this.modules.PIN_TUAN = moduleModels[2]
          this.modules.FENG_QIANG = moduleModels[3]
          this.modules.RECOMMEND = moduleModels[4]
        }
        if (type === 8) {
          this.modules.PIN_XUAN = moduleModels[0]
          this.modules.COUPON = moduleModels[1]
          this.modules.CHUN_YUN = moduleModels[2]
          this.modules.PIN_TUAN = moduleModels[3]
          this.modules.YU_GOU = moduleModels[4]
          this.modules.FENG_QIANG = moduleModels[5]
        }
        this.type = type
      } catch (e) {
        throw e
      }
    }
  },
  beforeRouteEnter (to, from, next) {
    next(vm => {
      if (vm.noFinish) {
        vm.$alert('主会场还在装修中哦，请您先看看我们都有哪些商品吧 😘')
          .finally(() => {
            vm.$router.replace({ name: 'Classify' })
          })
      }
    })
  }
}
</script>
<style module lang="scss">
  .d12 {
    position: relative;
    background: #d20001;
    .background {
      background: url("http://penglai-weimall.oss-cn-hangzhou.aliyuncs.com/static/admall/2.0.0/main-bg.jpg") no-repeat center top;
      background-size: 100% auto;
      min-height: 100vh;
    }
    .container {
      padding: 236px 24px 176px;
    }
    .btn-top {
      width: 520px;
      height: 78px;
      border-radius: 70px;
      margin: 0 auto 28px;
      &.coupon {
        background: url("http://penglai-weimall.oss-cn-hangzhou.aliyuncs.com/static/mall/2.0.0/activity/button-top.png") no-repeat center center;
        background-size: 100% auto;
        box-shadow: 18px 6px 25px #800F0F;
      }
      &.default {
        background: url("http://penglai-weimall.oss-cn-hangzhou.aliyuncs.com/static/mall/2.0.0/activity/Button 4.png") no-repeat center center;
        background-size: 100% auto;
        box-shadow: 18px 6px 25px #800F0F;
      }
    }
  }
</style>
